<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Precon Deck Picker</title>
  <style>
    html,body{height:100%}
    body{display:flex;align-items:center;justify-content:center;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;line-height:1.4;margin:0;padding:24px;background:#0b0b0b;color:#eaeaea}
    .card{max-width:720px;width:100%;text-align:center;background:#121212;border:1px solid #2a2a2a;border-radius:14px;padding:28px;box-shadow:0 10px 25px rgba(0,0,0,.35)}
    button{font-size:1rem;padding:.7rem 1.1rem;border-radius:10px;border:1px solid #3a3a3a;cursor:pointer;background:#1a1a1a;color:#fff}
    button[disabled]{opacity:.6;cursor:not-allowed}
    #result{margin-top:16px;font-size:1.05rem;min-height:304px;}
    #deckTitle{font-weight:600}
    a{color:#7ab4ff;text-decoration:none}
    a:hover{text-decoration:underline}
    .row{display:flex;align-items:center;gap:10px;justify-content:center;margin-top:8px}
    img.deck-img{display:block;margin:16px auto 0;max-width:100%;height:auto;border-radius:10px;border:1px solid #2a2a2a}
    .colors{display:flex;gap:6px;justify-content:center;margin:14px 0 0}
    .filters{display:block;margin:10px 0 12px}
    .filter-swatch-container{display:flex;gap:6px;justify-content:center;margin-top:8px;}
    .filter-swatch{width:22px;height:22px;border-radius:6px;border:1px solid #2a2a2a;cursor:pointer;transition:opacity .15s ease, filter .15s ease}
    .filter-swatch.unselected{opacity:.35;filter:grayscale(.6)}
    .tooltip-icon{display:inline-block;width:16px;height:16px;border-radius:50%;background:#555;color:#fff;text-align:center;line-height:16px;font-size:12px;font-weight:bold;cursor:help;margin-left:8px;position:relative}
    .tooltip-icon:hover .tooltip-text{visibility:visible;opacity:1}
    .tooltip-text{position:absolute;background:#333;color:#fff;padding:8px 12px;border-radius:6px;font-size:0.85rem;white-space:normal;width:200px;visibility:hidden;opacity:0;transition:visibility 0s linear 0.2s, opacity 0.2s ease;z-index:1000}
    .tooltip-text::after{content:'';position:absolute;top:-4px;left:50%;margin-left:-4px;border:4px solid transparent;border-bottom-color:#333}
    .color-swatch{width:18px;height:18px;border-radius:4px;border:1px solid #2a2a2a}
    .W{background:#f8f6f0}
    .U{background:#9cd3ff}
    .B{background:#3c3a3a}
    .R{background:#ff8d7a}
    .G{background:#7ed892}
  </style>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ²</text></svg>">
</head>
<body>
  <div class="card">
    <h1>Magic: The Gathering Commander<br><span id="user">Archidekt_Precons</span> Deck Picker</h1>
    <div style="margin-bottom: 16px;">
      <label for="userSelect" style="margin-right: 8px;">Select user:</label>
      <select id="userSelect">
        <option value="Archidekt_Precons" selected>Archidekt_Precons</option>
        <option value="jarnr">jarnr</option>
        <option value="pertrick">pertrick</option>
      </select>
    </div>
      <div id="colorFilters" class="filters" aria-label="Color filters">
        <label for="filterSelect" style="margin-right: 8px;">Filter Type:</label>
        <select id="filterSelect">
          <option value="subset" selected>Include Selected Colors</option>
          <option value="exact">Exact Match</option>
        </select>
        <span class="tooltip-icon" id="filterTooltip">
          i
          <span class="tooltip-text" id="tooltipText">This will pick from all decks containing the selected colors. Unselect a color to filter it out.</span>
        </span>
      <div class="filter-swatch-container">
        <span class="filter-swatch W" data-color="W" title="White"></span>
        <span class="filter-swatch B" data-color="B" title="Black"></span>
        <span class="filter-swatch U" data-color="U" title="Blue"></span>
        <span class="filter-swatch R" data-color="R" title="Red"></span>
        <span class="filter-swatch G" data-color="G" title="Green"></span>
      </div>
    </div>
    <p id="description">Click to randomly select an Archidekt preconstructed deck.</p>
    <button id="pick">Pick a deck</button>
    <div id="result"></div>
  </div>
  <script>
    const button = document.getElementById('pick');
    const result = document.getElementById('result');
    const userSelect = document.getElementById('userSelect');
    const modeSpan = document. getElementById('user');
    const description = document.getElementById('description');
    const colorFilters = document.getElementById('colorFilters');
    const filterSelect = document.getElementById('filterSelect');

    let username = 'Archidekt_Precons';
    modeSpan.textContent = username;
    description.textContent = 'Click to randomly select an Archidekt deck from the selected user.';
    userSelect.addEventListener('change', () => {
      username = userSelect.value;
      modeSpan.textContent = username;
    });

    let filter = 'subset';
    const tooltipText = document.getElementById('tooltipText');
    
    function updateTooltip() {
      if (filter === 'subset') {
        tooltipText.textContent = 'This will pick from all decks containing the selected colors. Unselect a color to filter it out.';
      } else {
        tooltipText.textContent = 'Select a deck containing exactly the selected colors.';
      }
    }
    
    filterSelect.addEventListener('change', () => {
      filter = filterSelect.value;
      updateTooltip();
    });
    
    // Initialize tooltip
    updateTooltip();

    // Color filter state: selected by default
    const selectedColors = new Set(['W','U','B','R','G']);
    colorFilters.addEventListener('click', (e) => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;
      const c = target.getAttribute('data-color');
      if (!c) return;
      if (selectedColors.has(c)) {
        selectedColors.delete(c);
        target.classList.add('unselected');
      } else {
        selectedColors.add(c);
        target.classList.remove('unselected');
      }
    });
    
    async function pickDeck(){
      button.disabled = true;
      button.textContent = 'Picking...';
      result.textContent = '';
      try {
        const colorSelection = Array.from(selectedColors).join('')
        const res = await fetch(`/pick?username=${encodeURIComponent(username)}&colors=${encodeURIComponent(colorSelection)}&filter_type=${encodeURIComponent(filter)}`, { cache: 'no-store' });
        if(!res.ok){
          const txt = await res.text();
          throw new Error(txt || ('HTTP ' + res.status));
        }
        const data = await res.json();
        const url = data.url;
        const title = data.title || 'Random Deck';
        const image = data.image || null;
        const colors = Array.isArray(data.colors) ? data.colors : [];
        document.title = title + ' Â· Preconstructed Deck Picker';

        const container = document.createElement('div');
        if (colors.length) {
          const colorsDiv = document.createElement('div');
          colorsDiv.className = 'colors';
          colors.forEach(c => {
            const sw = document.createElement('span');
            sw.className = 'color-swatch ' + c;
            colorsDiv.appendChild(sw);
          });
          container.appendChild(colorsDiv);
        }

        const titleWrap = document.createElement('div');
        titleWrap.style.marginTop = '8px';
        const titleText = document.createTextNode('Your random deck: ');
        const deckTitle = document.createElement('span');
        deckTitle.id = 'deckTitle';
        deckTitle.textContent = title;
        titleWrap.appendChild(titleText);
        titleWrap.appendChild(deckTitle);
        container.appendChild(titleWrap);

        const row = document.createElement('div');
        row.className = 'row';
        const a = document.createElement('a');
        a.id = 'deckLink';
        a.href = url;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = url;
        row.appendChild(a);
        const copyBtn = document.createElement('button');
        copyBtn.id = 'copyBtn';
        copyBtn.setAttribute('aria-label', 'Copy link');
        copyBtn.textContent = 'Copy link';
        row.appendChild(copyBtn);
        container.appendChild(row);

        if (image) {
          const img = document.createElement('img');
          img.className = 'deck-img';
          img.alt = 'Deck image';
          img.src = image;
          container.appendChild(img);
        }

        result.replaceChildren(container);

        copyBtn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(url);
            copyBtn.textContent = 'Copied!';
            setTimeout(() => copyBtn.textContent = 'Copy link', 1200);
          } catch {
            copyBtn.textContent = 'Copy failed';
            setTimeout(() => copyBtn.textContent = 'Copy link', 1200);
          }
        });
        button.textContent = 'Pick again';
      } catch (e){
        result.textContent = 'Error: ' + e.message;
        button.textContent = 'Try again';
      } finally {
        button.disabled = false;
      }
    }
    button.addEventListener('click', pickDeck);
  </script>
</body>
</html>

